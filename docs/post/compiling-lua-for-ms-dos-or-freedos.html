<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content="A step-by-step guide how to compile the Lua programming language interpreter for MS-DOS or FreeDOS. " name=description><meta content="lua, programming, algorithms, data-structures, gamedev, game development, blog, personal" name=keywords><meta content="Dmitri Smirnov" name=author><meta content=website property=og:type><meta content=https://www.whoop.ee/post/compiling-lua-for-ms-dos-or-freedos.html property=og:url><meta content=https://www.whoop.ee/assets/img/whoopee-logo.png property=og:image><meta content="script-src 'self'" http-equiv=Content-Security-Policy><meta content="object-src 'none'" http-equiv=Content-Security-Policy><title>Compiling Lua for MS-DOS/FreeDOS — Whoopee</title><link as=font href=/assets/fonts/Perfect_DOS_VGA_437.woff2 rel=preload><link href=/favicon.ico rel=icon type=image/x-icon><link href=/assets/css/styles.min.css rel=stylesheet><link title="RSS Feed" href=/feed.xml rel=alternate type=application/rss+xml><link href=https://www.whoop.ee/post/compiling-lua-for-ms-dos-or-freedos.html rel=canonical><body><header><a href=/><img alt=Whoopee class=logo height=172 src=/assets/img/whoopee-logo.png width=200></a><nav class=mainmenu><a href=/me/>About</a><a href=/feed.xml>RSS</a></nav></header><main><a href=/>← Back to the index page</a><article><h1>Compiling Lua for MS-DOS/FreeDOS</h1><time datetime=2025-03-24> March 24, 2025 </time><p>One cold spring day, while playing classic DOS games like <em>Wolfenstein 3D</em>, <em>Doom</em>, and <em>Mortal Kombat II</em>, I had a crazy idea—what if I could run the Lua programming language on DOS? Lua is lightweight, takes up very little memory, and is written in C. In theory, it should be possible to run it on any DOS-like operating system.<p>As I started researching, I realized I wasn’t the only one with this idea. I came across a developer from the United Kingdom who had already <a href=https://mathr.co.uk/blog/2022-05-11_lua_on_freedos.html>solved the problem</a> for Lua 5.4.4.<p>Building on <a href=https://mathr.co.uk/web/>Claude</a>’s solution, I made some minor modifications and improvements. Since I didn’t have an old machine, I had to run it on a modern computer via a USB flash drive. I tested the solution on three different setups:<ul><li><a href=https://freedos.org>FreeDOS 1.3</a><li><a href=https://winworldpc.com/product/ms-dos/622>MS-DOS 6.22</a><li><a href="https://www.dosbox.com/download.php?main=1">DOSBox</a></ul><p>All three ran Lua 5.4.7 without any issues, at least none that I’ve found so far!<h2 id=preparing-hardwaresoftware>Preparing hardware/software<a title="Permanent link" class=headerlink href=#preparing-hardwaresoftware>#</a></h2><p>Me (as you probably as well) do not have a 30-40-year-old machine to install DOS on hardware. Then a <a href=/post/how-to-create-bootable-freedos-usb-flash-drive-from-linux.html>USB drive handy can boot FreeDOS on modern PC</a>.<p>Another option is to use <a href="https://www.dosbox.com/download.php?main=1">DOSBox</a> emulator for the DOS operating system.<h2 id=issues>Issues<a title="Permanent link" class=headerlink href=#issues>#</a></h2><p><a href=https://mathr.co.uk/blog/2022-05-11_lua_on_freedos.html>Claude Heiland-Allen</a> fixed many issues in Lua’s source code to make it compatible with <em>Turbo C</em>, which I used as a foundation while making additional minor modifications to the C code.<p>The main issue here is that Borland Turbo C’s <code>offsetof</code> function is broken. As a workaround, Claude (thanks a lot!) defines it as <code>OFFSETOF</code>:<div class=codehilite><pre><span></span><code><span class=gi>+#define OFFSETOF(T,f) ((size_t)(char *)&(((T*)(void*)0)->f))</span>
</code></pre></div><p>Another challenge is the absence of locale support in DOS, which is inherently a Unix/Linux concept. To work around this, locale-related methods and constants are simply mocked in <code>luaconf.h</code>, and an empty <code>locale.h</code> file is placed in the source code directory to allow inclusion without errors.<div class=codehilite><pre><span></span><code><span class=gi>+#define CLOCKS_PER_SEC CLK_TCK</span>

<span class=gd>-</span>
<span class=gi>+/* locale */</span>
<span class=gi>+#define LC_ALL 0</span>
<span class=gi>+#define LC_COLLATE 1</span>
<span class=gi>+#define LC_CTYPE 2</span>
<span class=gi>+#define LC_MONETARY 3</span>
<span class=gi>+#define LC_NUMERIC 4</span>
<span class=gi>+#define LC_TIME 5</span>
<span class=gi>+#define strcoll strcmp</span>
<span class=gi>+#define setlocale(x,y) ("C")</span>
<span class=gi>+#define mktime(x) (-1)</span>
<span class=gi>+#define strftime(x,y,z,w) (0)</span>

<span class=w> </span>#endif
</code></pre></div><ul><li><a href=https://github.com/dknight/lua-for-dos/blob/main/lua-5.4.7-for-dos-with-borland-turbo-c-2.01.patch>Download my modified patch</a> lua-5.4.7-for-dos-with-borland-turbo-c-2.01.patch</ul><p>After numerous attempts and failures—mostly due to frustrating <code>out-of-memory</code> errors—I also discovered that line endings differ between DOS and Unix/Linux. The <code>unix2dos</code> command is a helpful tool for converting them, but for some reason, it didn’t completely resolve the issue. As a workaround, I passed the <code>--binary</code> flag to the <code>patch</code> utility.<p>You can find the scripts in the <a href=https://github.com/dknight/lua-for-dos>GitHub repo <em>lua-for-dos</em></a>.<h2 id=the-process>The process<a title="Permanent link" class=headerlink href=#the-process>#</a></h2><h3 id=step-1>Step 1<a title="Permanent link" class=headerlink href=#step-1>#</a></h3><ul><li>Download <em>Borland Turbo C</em> and Lua source code;<li><p>prepare Lua source code on the GNU/Linux machine.</p><li><p><a href=https://github.com/dknight/lua-for-dos/blob/main/prepare.sh><code>prepare.sh</code></a>: downloads required software and patches the source code. Runs on the GNU/Linux machine.</p></ul><div class=codehilite><pre><span></span><code>...<span class=w> </span>downloading<span class=w> </span>sofwtare<span class=w> </span>...
tar<span class=w> </span>-xvf<span class=w> </span><span class=s2>"</span><span class=nv>$LUA</span><span class=s2>.tar.gz"</span>
mv<span class=w> </span><span class=s2>"</span><span class=nv>$LUA</span><span class=s2>"</span><span class=w> </span>lua

<span class=nb>echo</span><span class=w> </span><span class=s1>'/* blank */'</span><span class=w> </span>><span class=w> </span>lua/src/locale.h
<span class=nb>cd</span><span class=w> </span>lua/
unix2dos<span class=w> </span>src/*<span class=w> </span>
unix2dos<span class=w> </span>../lua-5.4.7-for-dos-with-borland-turbo-c-2.01.patch
patch<span class=w> </span>-p1<span class=w> </span>-i<span class=w> </span><span class=s2>"../lua-5.4.7-for-dos-with-borland-turbo-c-2.01.patch"</span><span class=w> </span>--binary
</code></pre></div><div class="admonition tip"><p class=admonition-title>Tip<p>You can try to compile Lua with it <code>LUA_32BITS enabled</code>, but for some reason it does not work in FreeDOS. <a href=https://github.com/dknight/lua-for-dos/blob/main/lua-5.4.7-for-dos-with-borland-turbo-c-2.01.patch32bits>lua-5.4.7-for-dos-with-borland-turbo-c-2.01.patch32bits</a></div><h2 id=step-2>Step 2<a title="Permanent link" class=headerlink href=#step-2>#</a></h2><p>Compile under DOS by running the <a href=https://github.com/dknight/lua-for-dos/blob/main/COMPILE.BAT><code>COMPILE.BAT</code></a>. This DOS batch field and should be run inside DOS environment it won’t execute on the GNU/Linux machine.<div class=codehilite><pre><span></span><code><span class=k>PATH</span>=C:\TC
<span class=k>CD</span> C:\LUA\SRC
TCC -w- -ms- -mh -I. -c *.c
<span class=k>DEL</span> LUAC.OBJ
TCC -w- -ms- -mh -eLUA.EXE *.obj
<span class=k>DEL</span> LUA.OBJ
TCC -w- -ms- -mh -I. -c LUAC.C
TCC -w- -ms- -mh -eLUAC.EXE *.OBJ
<span class=k>CD</span> ..
<span class=k>MKDIR</span> BIN
<span class=k>COPY</span> SRC\LUA.EXE BIN
<span class=k>COPY</span> SRC\LUAC.EXE BIN
<span class=k>CD</span> BIN
LUA
</code></pre></div><p><a href=https://github.com/dknight/lua-for-dos/raw/refs/heads/main/bin/LUA4DOS.ZIP>Download Lua binaries compiled for DOS</a><h2 id=video-demonstration>Video demonstration<a title="Permanent link" class=headerlink href=#video-demonstration>#</a></h2><p>The compilation actually takes 5–10 minutes, depending on the machine. I tried to keep the videos under one minute.<h3 id=dosbox>DOSBox<a title="Permanent link" class=headerlink href=#dosbox>#</a></h3><video controls height=480 width=854><source src=/assets/video/luadosbox.mp4 type=video/mp4> Your browser does not support the video tag.</video><h3 id=pc>PC<a title="Permanent link" class=headerlink href=#pc>#</a></h3><video controls height=700 width=406><source src=/assets/video/luados.mp4 type=video/mp4> Your browser does not support the video tag.</video><h2 id=references>References<a title="Permanent link" class=headerlink href=#references>#</a></h2><ul><li><a href=/post/a-definitive-guide-for-compiling-lua-from-source-code.html>A definitive guide for compiling Lua from source code</a>.<li><a href=https://mathr.co.uk/blog/2022-05-11_lua_on_freedos.html>Claude Heiland-Allen’s post: Lua on FreeDOS</a><li><a href=/post/how-to-create-bootable-freedos-usb-flash-drive-from-linux.html>A Step-by-Step Guide to Creating a Bootable FreeDOS Flash Drive with a Live CD</a></ul><h2>Feedback</h2><p>For feedback, please check the <a href=/me/>contacts</a> section. Before writing, please specify where you came from and who you are. Sometimes spammers go insane. Thank you in advance for your understanding.</article><a href=/>← Back to the index page</a></main><footer><hr><p>(c) 2022-2025 <a href=/me/>xdknight</a> Powered by <a href=https://github.com/hmngwy/jenny>Jenny</a> shell blog engine.<p>Any images on this website may be used, copied and redistributed under the <a href=https://creativecommons.org/licenses/by/4.0/>CC BY 4.0</a> license.<p>Any code on this website may be used, copied and redistributed under the <a href=https://opensource.org/license/MIT>MIT</a> license.<p>This website does not use cookies or any tracking techniques either. Also, this page is fully accessible, responsive, and readable on any device without a single line of JavaScript.</footer>