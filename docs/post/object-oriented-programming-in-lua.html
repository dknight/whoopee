<!DOCTYPE html>
<html lang="en">
  <head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Object-oriented tutorial for Lua language. Examples with metatables, classes-, closure-, prototype-based and inheritance. ">
<meta name="keywords" content="lua, programming, algorithms, data-structures, gamedev, game development, blog, personal">
<meta name="author" content="Dmitri Smirnov">
<meta property="og:type" content="website">
<meta property="og:url" content="https://whoop.ee/post/object-oriented-programming-in-lua.html">
<meta property="og:image" content="https://whoop.ee/assets/img/lua-language.gif">
<meta http-equiv="Content-Security-Policy" content="script-src 'self'">
<meta http-equiv="Content-Security-Policy" content="object-src 'none'">
<title>Object-oriented programming in Lua &mdash; Whoopee</title>
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="stylesheet" href="/assets/css/styles.min.css">
<link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/feed.xml">
</head>
  <body>
      <header>
    <a href="/" class="logo">Whoopee</a>
    <nav class="mainmenu">
      <a href="/me/">About</a>
      <a href="/feed.xml">RSS</a>
    </nav>
  </header>
    <main>
      <a href="/"><em>&larr; Back to the index page</em></a>
      <article>
        <h1>Object-oriented programming in Lua</h1>
        <time datetime="2024-04-30">
          April 30, 2024
        </time>
        <!-- Description: Object-oriented tutorial for Lua language. Examples with metatables, classes-, closure-, prototype-based and inheritance. -->


<div class="toc">
<ul>
<li><a href="#object-oriented-programming-in-lua">Object-oriented programming in Lua</a><ul>
<li><a href="#metametable-based-classes">Metametable based classes</a><ul>
<li><a href="#making-instances">Making instances</a></li>
<li><a href="#metamethod-__index">Metamethod __index</a></li>
<li><a href="#defining-metatable">Defining metatable</a></li>
<li><a href="#inheritance">Inheritance</a></li>
<li><a href="#limitations">Limitations</a></li>
</ul>
</li>
<li><a href="#closure-based-classes">Closure-based classes</a><ul>
<li><a href="#inheritance_1">Inheritance</a></li>
</ul>
</li>
<li><a href="#prototype-based-inheritance">Prototype-based inheritance</a></li>
<li><a href="#annotations">Annotations</a></li>
<li><a href="#comparison">Comparison</a><ul>
<li><a href="#metatable-based-classes">Metatable-based classes</a><ul>
<li><a href="#pros">Pros</a></li>
<li><a href="#cons">Cons</a></li>
</ul>
</li>
<li><a href="#closure-based-classes_1">Closure-based classes</a><ul>
<li><a href="#pros_1">Pros</a></li>
<li><a href="#cons_1">Cons</a></li>
</ul>
</li>
<li><a href="#prototype-based">Prototype-based</a><ul>
<li><a href="#pros_2">Pros</a></li>
<li><a href="#cons_2">Cons</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#links">Links</a></li>
</ul>
</li>
</ul>
</div>
<p>Lua doesn&rsquo;t have classes and objects. <a href="https://www.lua.org/manual/5.4/manual.html#6.6"><code>table</code></a> is a single data structure to represent everything: arrays, maps, sets,
lists, queues, etc. Classes and <abbr title="Object-Oriented Programming">OOP</abbr> can be emulated with <code>table</code> data
structure and <a href="https://www.lua.org/manual/5.4/manual.html#2.4">metatables and metamethods</a>.
At first sight, it might be a bit confusing, but actually, it is a dead
simple solution.</p>
<h2 id="metametable-based-classes">Metametable based classes</h2>
<p>The most simple way to create a class is just to use a <code>table</code>.</p>
<p>Consider:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">local</span> <span class="n">Animal</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
  <span class="n">sound</span> <span class="o">=</span> <span class="s2">&quot;silence&quot;</span><span class="p">,</span>
  <span class="n">makeSound</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">sound</span><span class="p">)</span>
  <span class="kr">end</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">Animal</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">Animal</span><span class="p">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;feline&quot;</span>
<span class="n">Animal</span><span class="p">.</span><span class="n">sound</span> <span class="o">=</span> <span class="s2">&quot;Meow!&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Animal</span><span class="p">.</span><span class="n">makeSound</span><span class="p">(</span><span class="n">Animal</span><span class="p">))</span> <span class="c1">--&gt; &quot;Meow!&quot;</span>
</code></pre></div>

<p>Looks like it works, but here is a drawback; there is only <strong>one instance</strong> of
the <code>Animal</code> class and new instances cannot be created. Also please notice the
<code>self</code> variable in the <code>Animal:makeSound()</code> function, this is the same as
<code>Animal.makeSound(Animal)</code>. It is similar to JavaScript
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind">function binding</a>.</p>
<h3 id="making-instances">Making instances</h3>
<p>Firstly, just create an empty table.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">local</span> <span class="n">Animal</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div>

<p>Next, create a <code>new()</code> method which will return the instance of the class.</p>
<div class="codehilite"><pre><span></span><code><span class="kr">function</span> <span class="nc">Animal</span><span class="p">:</span><span class="nf">new</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kr">return</span> <span class="n">t</span>
<span class="kr">end</span>
</code></pre></div>

<p>Arguments can be passed in the function to set properties.
Also, methods can be defined here, if needed:</p>
<div class="codehilite"><pre><span></span><code><span class="kr">function</span> <span class="nc">Animal</span><span class="p">:</span><span class="nf">new</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">sound</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">t</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    <span class="n">t</span><span class="p">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
    <span class="n">t</span><span class="p">.</span><span class="n">sound</span> <span class="o">=</span> <span class="n">sound</span>
    <span class="kr">return</span> <span class="n">t</span>
<span class="kr">end</span>
</code></pre></div>

<p>Everything together with instances.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">local</span> <span class="n">Animal</span> <span class="o">=</span> <span class="p">{}</span>

<span class="kr">function</span> <span class="nc">Animal</span><span class="p">:</span><span class="nf">new</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">sound</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">t</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    <span class="n">t</span><span class="p">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
    <span class="n">t</span><span class="p">.</span><span class="n">sound</span> <span class="o">=</span> <span class="n">sound</span>
    <span class="kr">return</span> <span class="n">t</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">Animal</span><span class="p">.</span><span class="nf">makeSound</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">sound</span>
<span class="kr">end</span>

<span class="kd">local</span> <span class="n">cat</span> <span class="o">=</span> <span class="n">Animal</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;feline&quot;</span><span class="p">,</span> <span class="s2">&quot;Meow!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cat</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">Animal</span><span class="p">.</span><span class="n">makeSound</span><span class="p">(</span><span class="n">cat</span><span class="p">))</span> <span class="c1">--&gt; &quot;feline&quot; &quot;Meow!&quot;</span>

<span class="kd">local</span> <span class="n">dog</span> <span class="o">=</span> <span class="n">Animal</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;canis&quot;</span><span class="p">,</span> <span class="s2">&quot;Woof!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dog</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">Animal</span><span class="p">.</span><span class="n">makeSound</span><span class="p">(</span><span class="n">dog</span><span class="p">))</span> <span class="c1">--&gt; &quot;canis&quot; &quot;Woof!&quot;</span>

<span class="kd">local</span> <span class="n">hamster</span> <span class="o">=</span> <span class="n">Animal</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cricetinae&quot;</span><span class="p">,</span> <span class="s2">&quot;Eeeee!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">hamster</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">Animal</span><span class="p">.</span><span class="n">makeSound</span><span class="p">(</span><span class="n">hamster</span><span class="p">))</span> <span class="c1">--&gt; &quot;cricetinae&quot; &quot;Eeeee!&quot;</span>
</code></pre></div>

<p>It works! In this approach, methods can be accessed from the class, but the
syntax is a bit weird. From this point, <code>__index</code> metamethod comes to help
to make everything better.</p>
<h3 id="metamethod-__index">Metamethod <code>__index</code></h3>
<p>Lua allows to overload operators like <code>+</code>, <code>-</code>, <code>/</code>, <code>*</code> with metamethods.
In a lot of cases, metamethods can lead to great confusion, but for <abbr title="Object-Oriented">OO</abbr> classes,
it works greatly. There is metatmethod <code>__index</code> which overrides table
indexing mechanics. Failed methods lookups on the instances will get the class
table to access the methods and members.</p>
<p>Consider:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="c1">--&gt; 1</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="c1">--&gt; nil</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">z</span><span class="p">)</span> <span class="c1">--&gt; nil</span>
</code></pre></div>

<p>Here <code>t</code> table doesn&rsquo;t have <code>y</code> key, so <code>nil</code> is returned. But, <code>__index</code>
metamethod set using built-in Lua&rsquo;s function <code>setmetatable()</code> overrides
this behavior:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">setmetatable</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">__index</span> <span class="o">=</span> <span class="p">{</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">}</span>
<span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="c1">--&gt; 1</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="c1">--&gt; 2</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">z</span><span class="p">)</span> <span class="c1">--&gt; 3</span>
</code></pre></div>

<h3 id="defining-metatable">Defining metatable</h3>
<div class="codehilite"><pre><span></span><code><span class="n">Animal</span><span class="p">.</span><span class="n">__index</span> <span class="o">=</span> <span class="n">Animal</span>
</code></pre></div>

<p>This makes the &ldquo;magic&rdquo;, if method lookup fails on the instances, then it will
return the class&rsquo; table to access the methods. After this, <code>:</code> method access
operator can be used to make the syntax more clear.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">local</span> <span class="n">Animal</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">Animal</span><span class="p">.</span><span class="n">__index</span> <span class="o">=</span> <span class="n">Animal</span> <span class="c1">-- this makes &quot;magic&quot;</span>

<span class="kr">function</span> <span class="nc">Animal</span><span class="p">:</span><span class="nf">new</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">sound</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">t</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    <span class="n">t</span><span class="p">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
    <span class="n">t</span><span class="p">.</span><span class="n">sound</span> <span class="o">=</span> <span class="n">sound</span>
    <span class="kr">return</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">Animal</span><span class="p">:</span><span class="nf">makeSound</span><span class="p">()</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">sound</span>
<span class="kr">end</span>

<span class="kd">local</span> <span class="n">cat</span> <span class="o">=</span> <span class="n">Animal</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;feline&quot;</span><span class="p">,</span> <span class="s2">&quot;Meow!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cat</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">cat</span><span class="p">:</span><span class="n">makeSound</span><span class="p">())</span> <span class="c1">--&gt; &quot;feline&quot;   &quot;Meow!&quot;</span>

<span class="kd">local</span> <span class="n">dog</span> <span class="o">=</span> <span class="n">Animal</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;canis&quot;</span><span class="p">,</span> <span class="s2">&quot;Woof!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dog</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">dog</span><span class="p">:</span><span class="n">makeSound</span><span class="p">())</span> <span class="c1">--&gt; &quot;canis&quot;    &quot;Woof!&quot;</span>

<span class="kd">local</span> <span class="n">hamster</span> <span class="o">=</span> <span class="n">Animal</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cricetinae&quot;</span><span class="p">,</span> <span class="s2">&quot;Eeeee!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">hamster</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">hamster</span><span class="p">:</span><span class="n">makeSound</span><span class="p">())</span> <span class="c1">--&gt; &quot;cricetinae&quot;   &quot;Eeeee!&quot;</span>
</code></pre></div>

<h3 id="inheritance">Inheritance</h3>
<p>Inheritance means that the child (subclass) class should
access all its parent methods and members and override them if needed.
It is fairly easy to achieve.</p>
<p>Another way to use metatables:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">local</span> <span class="n">Cat</span> <span class="o">=</span> <span class="p">{}</span>

<span class="kr">function</span> <span class="nc">Cat</span><span class="p">:</span><span class="nf">new</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">age</span><span class="p">,</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;feline&quot;</span><span class="p">,</span>
        <span class="n">sound</span> <span class="o">=</span> <span class="s2">&quot;Meow!&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="nb">setmetatable</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">{</span> <span class="n">__index</span> <span class="o">=</span> <span class="n">Cat</span> <span class="p">})</span>
    <span class="nb">setmetatable</span><span class="p">(</span><span class="n">Cat</span><span class="p">,</span> <span class="p">{</span> <span class="n">__index</span> <span class="o">=</span> <span class="n">Animal</span> <span class="p">})</span>
    <span class="kr">return</span> <span class="n">t</span>
<span class="kr">end</span>

<span class="c1">-- override</span>
<span class="kr">function</span> <span class="nc">Cat</span><span class="p">:</span><span class="nf">makeSound</span><span class="p">()</span>
    <span class="kr">return</span> <span class="nb">string.rep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">sound</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kd">local</span> <span class="n">kitty</span> <span class="o">=</span> <span class="n">Cat</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">kitty</span><span class="p">.</span><span class="n">age</span><span class="p">,</span> <span class="n">kitty</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">kitty</span><span class="p">:</span><span class="n">makeSound</span><span class="p">())</span> <span class="c1">--&gt; 4   &quot;feline&quot;    &quot;Meow!Meow!Meow!&quot;</span>
</code></pre></div>

<h3 id="limitations">Limitations</h3>
<p>There are no real private members or methods in Lua. Usually, these are
prefixed with underscore <code>_</code>. But actually, everything is public with
this approach.</p>
<p>Another good way to mark method or member as private use
<a href="#annotations">annotations</a>.
Modern IDEs should help with that.</p>
<div class="codehilite"><pre><span></span><code><span class="n">Animal</span><span class="p">:</span><span class="n">_privateMethod</span><span class="p">()</span>
</code></pre></div>

<p>Also, there is no static scope for classes. Somewhat similar to static can be
achieved using the table constructor. But such defined members also will be
accessible on the instances.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">local</span> <span class="n">Cat</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">REIGN</span> <span class="o">=</span> <span class="s2">&quot;mammals&quot;</span>
  <span class="c1">-- ...</span>
<span class="p">}</span>

<span class="kr">function</span> <span class="nc">Cat</span><span class="p">:</span><span class="nf">new</span><span class="p">()</span>
    <span class="c1">-- ...</span>
<span class="kr">end</span>

<span class="nb">print</span><span class="p">(</span><span class="n">Cat</span><span class="p">.</span><span class="n">REIGN</span><span class="p">)</span> <span class="c1">--&gt; &quot;mammals&quot;</span>
</code></pre></div>

<h2 id="closure-based-classes">Closure-based classes</h2>
<p>Another approach is to use closure for classes. One of the
advantages private variables can be used as <code>local</code> variables. The Second
advantage is no need to deal with metatables and <code>:</code> method accessor.</p>
<p>Consider <code>Animal</code> class:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">local</span> <span class="kr">function</span> <span class="nf">Animal</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">sound</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">self</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">age</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span> <span class="ow">or</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
        <span class="n">sound</span> <span class="o">=</span> <span class="n">sound</span> <span class="ow">or</span> <span class="s2">&quot;silence&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="kr">function</span> <span class="nc">self</span><span class="p">.</span><span class="nf">makeSound</span><span class="p">()</span>
        <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">sound</span>
    <span class="kr">end</span>

    <span class="c1">---@private</span>
    <span class="kd">local</span> <span class="kr">function</span> <span class="nf">privateMethod</span><span class="p">()</span>
        <span class="kr">return</span> <span class="s1">&#39;something private&#39;</span>
    <span class="kr">end</span>

    <span class="kr">return</span> <span class="n">self</span>
<span class="kr">end</span>

<span class="kd">local</span> <span class="n">cat</span> <span class="o">=</span> <span class="n">Animal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;feline&quot;</span><span class="p">,</span> <span class="s2">&quot;Meow!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cat</span><span class="p">.</span><span class="n">age</span><span class="p">,</span> <span class="n">cat</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">cat</span><span class="p">.</span><span class="n">makeSound</span><span class="p">())</span>
</code></pre></div>

<h3 id="inheritance_1">Inheritance</h3>
<p>Inheritance for closure-based is also straightforward.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">local</span> <span class="kr">function</span> <span class="nf">Animal</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">sound</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">self</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">age</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span> <span class="ow">or</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
        <span class="n">sound</span> <span class="o">=</span> <span class="n">sound</span> <span class="ow">or</span> <span class="s2">&quot;silence&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="kr">function</span> <span class="nc">self</span><span class="p">.</span><span class="nf">makeSound</span><span class="p">()</span>
        <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">sound</span>
    <span class="kr">end</span>

    <span class="c1">---@private</span>
    <span class="kd">local</span> <span class="kr">function</span> <span class="nf">privateMethod</span><span class="p">()</span>
        <span class="kr">return</span> <span class="s1">&#39;something private&#39;</span>
    <span class="kr">end</span>

    <span class="kr">return</span> <span class="n">self</span>
<span class="kr">end</span>

<span class="kd">local</span> <span class="kr">function</span> <span class="nf">Cat</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">self</span> <span class="o">=</span> <span class="n">Animal</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="s2">&quot;feline&quot;</span><span class="p">,</span> <span class="s2">&quot;Meow!&quot;</span><span class="p">)</span>

    <span class="c1">-- override</span>
    <span class="kr">function</span> <span class="nc">self</span><span class="p">.</span><span class="nf">makeSound</span><span class="p">()</span>
        <span class="kr">return</span> <span class="nb">string.rep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">sound</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="kr">end</span>

    <span class="kr">return</span> <span class="n">self</span>
<span class="kr">end</span>

<span class="kd">local</span> <span class="n">kitty</span> <span class="o">=</span> <span class="n">Cat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">kitty</span><span class="p">.</span><span class="n">age</span><span class="p">,</span> <span class="n">kitty</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">kitty</span><span class="p">.</span><span class="n">makeSound</span><span class="p">())</span>
</code></pre></div>

<h2 id="prototype-based-inheritance">Prototype-based inheritance</h2>
<p>Prototype-based approach doesn&rsquo;t use classes (class-free <abbr title="Object-Oriented Programming">OOP</abbr>), it uses cloning
and prototype delegation. More about
<a href="https://en.wikipedia.org/wiki/Prototype-based_programming">prototype-based object-oriented programming</a>.</p>
<p>Here is the most basic example of the prototype-based approach. First of all need
to define some helper functions.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">---@param a any</span>
<span class="c1">---@param b any</span>
<span class="c1">---@return table</span>
<span class="kd">local</span> <span class="kr">function</span> <span class="nf">clone</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="kr">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&quot;table&quot;</span> <span class="kr">then</span>
        <span class="kr">return</span> <span class="n">b</span> <span class="ow">or</span> <span class="n">a</span>
    <span class="kr">end</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">b</span><span class="p">.</span><span class="n">__index</span> <span class="o">=</span> <span class="n">a</span>
    <span class="kr">return</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">---@param a any</span>
<span class="c1">---@param b any</span>
<span class="c1">---@return boolean</span>
<span class="kd">local</span> <span class="kr">function</span> <span class="nf">isPrototypeOf</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">bType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">aType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="kr">if</span> <span class="n">bType</span> <span class="o">~=</span> <span class="s2">&quot;table&quot;</span> <span class="ow">and</span> <span class="n">aType</span> <span class="o">~=</span> <span class="s2">&quot;table&quot;</span> <span class="kr">then</span>
        <span class="kr">return</span> <span class="n">bType</span> <span class="o">==</span> <span class="n">aType</span>
    <span class="kr">end</span>
    <span class="kd">local</span> <span class="n">index</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">__index</span>
    <span class="kd">local</span> <span class="n">_isa</span> <span class="o">=</span> <span class="n">index</span> <span class="o">==</span> <span class="n">a</span>
    <span class="kr">while</span> <span class="ow">not</span> <span class="n">_isa</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">do</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">__index</span>
        <span class="n">_isa</span> <span class="o">=</span> <span class="n">index</span> <span class="o">==</span> <span class="n">a</span>
    <span class="kr">end</span>
    <span class="kr">return</span> <span class="n">_isa</span>
<span class="kr">end</span>
</code></pre></div>

<p>After the functions, new instances can be created:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">local</span> <span class="n">Animal</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
    <span class="n">sound</span> <span class="o">=</span> <span class="s2">&quot;silence&quot;</span><span class="p">,</span>
    <span class="n">makeSound</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">sound</span>
    <span class="kr">end</span><span class="p">,</span>
    <span class="n">clone</span> <span class="o">=</span> <span class="n">clone</span><span class="p">,</span>
    <span class="n">isPrototypeOf</span> <span class="o">=</span> <span class="n">isPrototypeOf</span><span class="p">,</span>
<span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Animal</span><span class="p">.</span><span class="n">age</span><span class="p">,</span> <span class="n">Animal</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">Animal</span><span class="p">:</span><span class="n">makeSound</span><span class="p">(),</span> <span class="n">Animal</span><span class="p">:</span><span class="n">isPrototypeOf</span><span class="p">(</span><span class="n">table</span><span class="p">))</span> <span class="c1">--&gt; 0   &quot;unknown&quot;   &quot;silence&quot;   true</span>


<span class="kd">local</span> <span class="n">cat</span> <span class="o">=</span> <span class="n">Animal</span><span class="p">:</span><span class="n">clone</span><span class="p">()</span>
<span class="n">cat</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">cat</span><span class="p">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;feline&quot;</span>
<span class="n">cat</span><span class="p">.</span><span class="n">sound</span> <span class="o">=</span> <span class="s2">&quot;Meow!&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cat</span><span class="p">.</span><span class="n">age</span><span class="p">,</span> <span class="n">cat</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">cat</span><span class="p">:</span><span class="n">makeSound</span><span class="p">(),</span> <span class="n">cat</span><span class="p">:</span><span class="n">isPrototypeOf</span><span class="p">(</span><span class="n">Animal</span><span class="p">))</span> <span class="c1">--&gt; 4  &quot;feline&quot;    &quot;Meow!&quot; true</span>

<span class="kd">local</span> <span class="n">dog</span> <span class="o">=</span> <span class="n">Animal</span><span class="p">:</span><span class="n">clone</span><span class="p">()</span>
<span class="n">dog</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">dog</span><span class="p">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;canis&quot;</span>
<span class="n">dog</span><span class="p">.</span><span class="n">sound</span> <span class="o">=</span> <span class="s2">&quot;Woof!&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dog</span><span class="p">.</span><span class="n">age</span><span class="p">,</span> <span class="n">dog</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">dog</span><span class="p">:</span><span class="n">makeSound</span><span class="p">(),</span> <span class="n">cat</span><span class="p">:</span><span class="n">isPrototypeOf</span><span class="p">(</span><span class="n">Animal</span><span class="p">))</span> <span class="c1">--&gt; 3  &quot;canis&quot; &quot;Woof!&quot; true</span>
</code></pre></div>

<h2 id="annotations">Annotations</h2>
<p><a href="https://luals.github.io/wiki/annotations/">Annotations</a> for
<a href="https://luals.github.io">Lua Language Server</a>
can be very handy and greatly improve the <abbr title="Developer Experience">DX</abbr>. Here is the example for <code>Animal</code>
and <code>Cat</code> classes with annotations.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Notice that annotations are just Lua&rsquo;s comments, but begin witha a triple
    dash (<code>---</code>).</p>
</div>
<div class="codehilite"><pre><span></span><code><span class="c1">---@class Animal</span>
<span class="c1">---@field public age number</span>
<span class="c1">---@field public kind string</span>
<span class="c1">---@field public sound string</span>
<span class="kd">local</span> <span class="n">Animal</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">Animal</span><span class="p">.</span><span class="n">__index</span> <span class="o">=</span> <span class="n">Animal</span>

<span class="c1">---@param age number</span>
<span class="c1">---@param kind string</span>
<span class="c1">---@param sound string</span>
<span class="c1">---@return Animal</span>
<span class="kr">function</span> <span class="nc">Animal</span><span class="p">:</span><span class="nf">new</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">sound</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">t</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    <span class="n">t</span><span class="p">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
    <span class="n">t</span><span class="p">.</span><span class="n">sound</span> <span class="o">=</span> <span class="n">sound</span>
    <span class="kr">return</span> <span class="nb">setmetatable</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">---@return string</span>
<span class="kr">function</span> <span class="nc">Animal</span><span class="p">:</span><span class="nf">makeSound</span><span class="p">()</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">sound</span>
<span class="kr">end</span>

<span class="c1">---@class Cat : Animal</span>
<span class="kd">local</span> <span class="n">Cat</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">---@return Cat</span>
<span class="kr">function</span> <span class="nc">Cat</span><span class="p">:</span><span class="nf">new</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">t</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    <span class="n">t</span><span class="p">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;feline&quot;</span>
    <span class="n">t</span><span class="p">.</span><span class="n">sound</span> <span class="o">=</span> <span class="s2">&quot;Meow!&quot;</span>
    <span class="nb">setmetatable</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">{</span> <span class="n">__index</span> <span class="o">=</span> <span class="n">Cat</span> <span class="p">})</span>
    <span class="nb">setmetatable</span><span class="p">(</span><span class="n">Cat</span><span class="p">,</span> <span class="p">{</span> <span class="n">__index</span> <span class="o">=</span> <span class="n">Animal</span> <span class="p">})</span>
    <span class="kr">return</span> <span class="n">t</span>
<span class="kr">end</span>

<span class="c1">-- override</span>
<span class="kr">function</span> <span class="nc">Cat</span><span class="p">:</span><span class="nf">makeSound</span><span class="p">()</span>
    <span class="kr">return</span> <span class="nb">string.rep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">sound</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kd">local</span> <span class="n">kitty</span> <span class="o">=</span> <span class="n">Cat</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">tom</span> <span class="o">=</span> <span class="n">Cat</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">kitty</span><span class="p">.</span><span class="n">age</span><span class="p">,</span> <span class="n">kitty</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">kitty</span><span class="p">:</span><span class="n">makeSound</span><span class="p">())</span> <span class="c1">--&gt; 1   &quot;feline&quot;    &quot;Meow!Meow!Meow!&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tom</span><span class="p">.</span><span class="n">age</span><span class="p">,</span> <span class="n">tom</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">tom</span><span class="p">:</span><span class="n">makeSound</span><span class="p">())</span> <span class="c1">--&gt; 2 &quot;feline&quot;    &quot;Meow!Meow!Meow!&quot;</span>
</code></pre></div>

<h2 id="comparison">Comparison</h2>
<p>This is a <em>very rough</em> comparison. The results are average for many runs.</p>
<p>Resources consumed:</p>
<table>
<thead>
<tr>
<th>Approach</th>
<th>Memory</th>
<th>Time</th>
</tr>
</thead>
<tbody>
<tr>
<td>Closure</td>
<td>257833.97 Kb</td>
<td>0m6.259s</td>
</tr>
<tr>
<td>Metatable</td>
<td>164843.76 Kb</td>
<td>0m6.495s</td>
</tr>
<tr>
<td>Prototype</td>
<td>164844.70 Kb</td>
<td>0m16.715s</td>
</tr>
</tbody>
</table>
<p>The conclusion can be made that closure-based classes take
more memory. The methods and members&rsquo; accessors aren&rsquo;t much faster,
as <a href="https://www.lua-users.org/wiki/ObjectOrientationTutorial">mentioned in the article</a>.</p>
<details>
  <summary>Closure-based class test code</summary>
  <pre>local function Animal(age, kind, sound)
    local self = {
        age = age or 0,
        kind = kind or "unknown",
        sound = sound or "silence",
    }
    function self.makeSound()
        return self.sound
    end
    -- @private
    local function privateMethod()
        return "something private"
    end
    return self
end

local ITERS = 1000000
local cats = {}
for i = 1, ITERS do
    local cat = Animal(2, "feline", "Meow!")
    cats[i] = cat
    print(cat.age, cat.kind, cat:makeSound())
end

local res = collectgarbage("count")
print(res .. "kb")</pre>
</details>
<details>
  <summary>Metatables-based class test code</summary>
  <pre>local Animal = {}
Animal.__index = Animal

function Animal:new(age, kind, sound)
    self.age = age or 0
    self.kind = kind or "unknown",
    self.sound = sound or "silence",
    return setmetatable(t, self)
end

function Animal:makeSound()
    return self.sound
end

local ITERS = 1000000
local cats = {}
for i = 1, ITERS do
    local cat = Animal:new(2, "feline", "Meow!")
    cats[i] = cat
    print(cat.age, cat.kind, cat:makeSound())
end

local res = collectgarbage("count")
print(res .. "kb")</pre>
</details>
<details>
<summary>Prototype-based test code</summary>
<pre>---@param a any
---@param b any
---@return table
local function clone(a, b)
    if type(a) ~= "table" then
        return b or a
    end
    b = b or {}
    b.__index = a
    return setmetatable(b, b)
end

---@param a any
---@param b any
---@return boolean
local function isPrototypeOf(b, a)
    local bType = type(b)
    local aType = type(a)
    if bType ~= "table" and aType ~= "table" then
        return bType == aType
    end
    local index = b.__index
    local _isa = index == a
    while not _isa and index ~= nil do
        index = a.__index
        _isa = index == a
    end
    return _isa
end

local Animal = clone(table, {
    age = 0,
    kind = "unknown",
    sound = "silence",
    makeSound = function(self)
        return self.sound
    end,
    clone = clone,
    isPrototypeOf = isPrototypeOf,
})

local ITERS = 1000000
local cats = {}
for i = 1, ITERS do
    local cat = Animal:clone()
    cat.age = 4
    cat.kind = "feline"
    cat.sound = "Meow!"
    print(cat.age, cat.kind, cat:makeSound(), cat:isPrototypeOf(Animal))
    cats[i] = cat
    print(cat.age, cat.kind, cat:makeSound())
end

local res = collectgarbage("count")
print(res .. "kb")</pre>
</details>

<h3 id="metatable-based-classes">Metatable-based classes</h3>
<h4 id="pros">Pros</h4>
<ul>
<li>The lowest memory consumed;</li>
<li>the fastest speed;</li>
<li>possible to get methods directly from class <code>Class.method(instance, args))</code>.</li>
</ul>
<h4 id="cons">Cons</h4>
<ul>
<li>The code might be a bit more confusing than the closure approach.</li>
</ul>
<h3 id="closure-based-classes_1">Closure-based classes</h3>
<h4 id="pros_1">Pros</h4>
<ul>
<li>More clear syntax (easier to write);</li>
<li>a bit faster than metatable-based classes;</li>
<li>can have truly private fields.</li>
</ul>
<h4 id="cons_1">Cons</h4>
<ul>
<li>More memory is required.</li>
</ul>
<h3 id="prototype-based">Prototype-based</h3>
<h4 id="pros_2">Pros</h4>
<ul>
<li>Uses a different approach, but is technically very similar to meta tables.</li>
</ul>
<h4 id="cons_2">Cons</h4>
<ul>
<li>Probably the slowest solution;</li>
<li>code can be confusing;</li>
<li>extra code is required like <code>clone()</code> function.</li>
</ul>
<p>Another comparison opinion can be read in
<a href="https://www.lua-users.org/wiki/ObjectOrientationTutorial">lua-users.org article</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In my opinion <a href="#metametable-based-classes">metatable</a> method is the most optimal
in performance and maintainability. Of course, everything depends on the task.
Sometimes maintainability is more important than performance, especially
if you are working in a large team with different technical skills. What
approach to choose is up to you.</p>
<h2 id="links">Links</h2>
<ul>
<li><a href="https://www.lua-users.org/wiki/ObjectOrientationTutorial">Object Orientation Tutorial</a></li>
<li><a href="https://www.lua-users.org/wiki/ObjectOrientedProgramming">Object Oriented Programming</a></li>
<li><a href="https://gist.github.com/liquidev/3f37f94efdacd14a654a4bdc37c8008f">Article on GitHub</a></li>
<li><a href="https://www.lua.org/pil/16.html">Programming in Lua Book Chapter 16: Object-Oriented Programming</a></li>
<li><a href="https://luals.github.io">Lua Language Server</a></li>
<li><a href="https://betterprogramming.pub/oop-in-lua-9962e47ed603">Object-Oriented Programming in Lua using Annotations</a></li>
</ul>
        <h2>Feedback</h2>
<p>
For feedback, please check the <a href="/about.html#contacts">contacts</a> section.
Before writing, please specify where you came from and who you are. Sometimes spammers go insane.
Thank you in advance for your understanding.
</p>
      </article>
      <a href="/"><em>&larr; Back to the index page</em></a>
    </main>
      <footer>
    <hr>
    <p>
      &copy; 2022&mdash;2024 <a href="/about.html">xdknight</a>
      Powered by <a href="https://github.com/hmngwy/jenny">Jenny</a> shell
      blog engine. <a href="https://github.com/dknight/whoopee">Source code</a>
    </p>
    <p>
      Any images on this website may be used, copied and redistributed under the
      <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0 Deed</a> license.
    </p>
    <p>
      Any code on this website may be used, copied and redistributed under the
      <a href="https://opensource.org/license/MIT">MIT</a> license.
    </p>
    <p>
      This website <strong>does not</strong> use cookies or any tracking techniques either.
      Also, this page is fully accessible, responsive, and readable on any
      device without a single line of <abbr title="Tool of evil">JavaScript</abbr>.
    </p>
  </footer>
  </body>
</html>
